<!DOCTYPE html>
<html lang="en">

<head>
    <title>Wikidata Reference Verification</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/mturk-public/externalHIT_v1.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
        integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous" />
    <style>
        input[type="range"].unmoved::-webkit-slider-thumb {
            border: 1px solid #dddddd;
            background: #dddddd;
        }

        input[type="range"].unmoved::-moz-range-thumb {
            border: 1px solid #dddddd;
            background-color: #dddddd;
        }
    </style>
</head>

<body>
    <div class="container p-5">
        <div class="row justify-content-center">
            <button type="button" class="btn btn-primary col-sm-12 d-none" data-toggle="collapse"
                data-target="#instructions-panel" id="instructions-toggle">
                <span id="instructions-toggle-text">Show Instructions</span>
            </button>
        </div>
        <div id="instructions-btns" class="row">
            <button type="button" class="btn btn-primary mr-auto col-sm-2 mb-3 d-none" id="intro-previous">
                Previous
            </button>
            <button type="button" class="btn btn-primary ml-auto col-sm-2 mb-3" id="intro-next">
                Next
            </button>
            <button type="button" class="btn btn-success ml-auto col-sm-2 mb-3 d-none" id="ready-button">
                Proceed
            </button>
        </div>
        <div id="instructions-panel" class="row">
            <div class="col-sm-12 mx-auto border rounded shadow-sm text-center" style="background-color: #f5f5f5;">
                <h4 class="text-left mt-3"><strong>Task instructions</strong></h4>
                <div class="text-left">
                    <div id="instructions-0" class="instructions active">
                        <h5><b>Project</b></h5>
                        <p id="instructions-project-text"></p>
                    </div>
                    <div id="instructions-1" class="instructions d-none">
                        <h5><b>Introduction</b></h5>
                        <p id="instructions-intro-text"></p>
                    </div>
                    <div id="instructions-2" class="instructions d-none">
                        <h5><b>Examples</b></h5>
                        <p id="instructions-examples-text">
                        <h6>Controls:</h6>
                        <p>You will be asked to fill a form consisting of:</p>
                        <ol>
                            <li>A choice of author type among three options: <b>Individual</b> (a person, easily identifiable by signature, photo, name, description, etc); <b>Organization</b> (any organized group of people that act as one, under a company name, like an agency, company, institute, etc); or <b>Collective</b> (a group of anonymous people who build content together, but are each independent of each other, like forums or <b>Wikipedias</b>).</li>
                            <li>A choice of publisher type among five options: <b>Academic/Scientific</b>, any publisher that releases academic and scientific material or publications; <b>Organizations of Commercial/Political/Religious/Cultural type</b>, any publisher that is  a company or organization which operates in these domains;<b>Government Agencies</b>, for any publisher that publishes government content, be it in any sphere; <b>News and Media outlets</b>, for any publisher that publishes news reports, columns, etc; and <b>Self published sources and blogs</b>, for any publisher that is also the author, and is not classified in the previous options, like social media, wikipedias, and sites with user-generated content.</li>
                            <li>A choice of publisher sub-types depending on your answer to the question above.</li>
                        </ol>
                        <h6>Example 1:</h6>
                        <p>
                            <b>Website:</b> <a
                                href="https://www.thestudentroom.co.uk/forum.php"
                                target="_blank">https://www.thestudentroom.co.uk/forum.php</a><br><br>
                        <div style="text-align: center"><img src='https://i.imgur.com/ejuWDOb.png' width="75%"></div>
                        <br>
                        In this example, the website takes you to a forum board, where students can discuss varied topics. The type of author here is a collective of individuals with nicknames, so we can say that the type here is a <b>Collective</b>. As for the type of publisher, we can see that it is a <b>Self published sources and blogs</b>, mainly because it is a platform where you can publish your writings yourself for others to see. The type has no subtypes.
                        </p>
                        <h6>Example 2:</h6>
                        <p>
                            <b>Website:</b> <a
                                href="https://www.ebi.ac.uk/"
                                target="_blank">https://www.ebi.ac.uk/</a><br><br>
                        <div style="text-align: center"><img src='https://i.imgur.com/yJS0ViT.png' width="75%"></div>
                        <br>
                        In this example, the website takes you to a website with hosts biological data for academic and scientific use. The type of author here is an <b>Organization</b>, as it is the European Bioinformatics Institute itself which makes the datasets available. As for the type of publisher, we can see that it is an <b>Academic / Scientific</b> type of publisher. The subtype would be <b>Academic and research institutions</b>, as it is an institute.
                        </p>
                        <h6>Example 3:</h6>
                        <p>
                            <b>Website:</b> <a
                                href="https://www.independent.co.uk/"
                                target="_blank">https://www.independent.co.uk/</a><br><br>
                        <div style="text-align: center"><img src='https://i.imgur.com/o0WhwNL.png' width="75%"></div>
                        <br>
                        In this example, the website takes you to a mainstream news page. By clicking in any article, we can see that the type of author here is an <b>Individual</b>, with their name on the top of the article. As for the type of publisher, we can see that it is <b>News and media outlets</b>. The subtype, as it is a known mainstream source of news, is <b>Traditional news and media</b>.
                        </p>
                        <h6>Example 4:</h6>
                        <p>
                            <b>Website:</b> <a
                                href="https://www.metmuseum.org/"
                                target="_blank">https://www.metmuseum.org/</a><br><br>
                        <div style="text-align: center"><img src='https://i.imgur.com/7sXuzbv.png' width="75%"></div>
                        <br>
                        In this example, the website takes you the website of an American museum. The type of author here is the museum staff itself, so it is an <b>Organization</b>. As for the type of publisher, we can see that it is <b>Commercial / Political / Religious / Cultural</b>, but more specifically, the subtype is <b>Cultural Institution</b>. 
                        </p>
                        <h6>Example 5:</h6>
                        <p>
                            <b>Website:</b> <a
                                href="https://www.gov.uk/"
                                target="_blank">https://www.gov.uk/</a><br><br>
                        <div style="text-align: center"><img src='https://i.imgur.com/sNSGfXP.png' width="75%"></div>
                        <br>
                        In this example, the website takes you to a government portal. The type of author here is the government, as only the government can write content to that website, so it is an <b>Organization</b>. As for the type of publisher, we can see that it is classified as <b>Government Agencies</b>. This type has no subtypes.
                        </p>
                        </p>
                    </div>
                    <div id="instructions-3" class="instructions d-none">
                        <h5><b>Task rules</b></h5>
                        <p id="instructions-rules-text"></p>
                    </div>
                    <div id="instructions-4" class="instructions d-none">
                        <div id="lan_test" class="text-left">
                            <p><b>Language Test: </b><span id='lan_test_language'></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br />
        <div id="task-panel" class="row d-none">
            <div class="col-sm-12 mx-auto border rounded shadow-sm" style="background-color: #f5f5f5;">
                <h4 class="text-left mt-3">
                    Reference <strong><span id="current-page"></span></strong> of
                    <strong><span id="n-pages"></span></strong>:
                </h4>
                <br />
                <!---->
                <div class="row d-flex justify-content-center">
                    <div class="col-sm-11 pr-0 pl-0">
                        <h5>Look at the following website:
                        </h5>
                    </div>
                </div>
                <div class="row d-flex justify-content-center">
                    <div class="col-sm-11 bg-light border rounded p-2">
                        <p><b>Web reference:</b> <a href="" target="_blank" id="website_reference"></a></p>
                    </div>
                </div>
                <br />
                <!---->
                <div id="author-panel" class=''>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-11 pr-0 pl-0">
                            <h5>Please select the type of author that publishes information to this website (This is <b>not about the content</b> of the website</b>, but about the <b>author of the content</b>):</h5>
                        </div>
                    </div>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-11 pr-0 pl-0">
                            <div class="btn-group btn-group-vertical" data-toggle="buttons" style="width: 100%;">
                                <label id="author_0" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='unavailable' name='author_radios'>
                                    Individual (One individual, a specific person, publishes and the <b>author's identity is visibile</b> in the content)
                                </label>
                                <label id="author_1" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='security' name='author_radios'>
                                    Organization (<b>An organization itself</b> publishes and its name or logo is visible in the content)
                                </label>
                                <label id="author_2" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='login_required' name='author_radios'>
                                    Collective (A collective of <b>anonymous individuals</b> publishes or edits and the name of the individual is not visible, or only a handle/nickname can be seen)
                                </label>
                                <label id="author_3" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='login_required' name='author_radios'>
                                    I could not access the website due to browsers errors, paywalls, or other reasons.
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <br />
                <!---->
                <div id="publisher-panel" class=''>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-11 pr-0 pl-0">
                            <h5>Please select the type of publisher that this site most closely classifies as:</h5>
                        </div>
                    </div>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-11 pr-0 pl-0">
                            <div class="btn-group btn-group-vertical" data-toggle="buttons" style="width: 100%;">
                                <label id="publisher_0" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='unavailable' name='publisher_radios'>
                                    Academic / Scientific
                                </label>
                                <label id="publisher_1" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='security' name='publisher_radios'>
                                    Commercial / Political / Religious / Cultural
                                </label>
                                <label id="publisher_2" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='login_required' name='publisher_radios'>
                                    Government Agencies
                                </label>
                                <label id="publisher_3" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='login_required' name='publisher_radios'>
                                    News and Media outlets
                                </label>
                                <label id="publisher_4" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='login_required' name='publisher_radios'>
                                    Self published sources and blogs
                                </label>
                                <label id="publisher_5" class="btn btn-primary">
                                    <input type="radio" autocomplete="off" value='login_required' name='publisher_radios'>
                                    I could not access the website due to browsers errors, paywalls, or other reasons.
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <br />
                <!---->
                <div id="sub-publisher-panel" class='d-none'>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-11 pr-0 pl-0">
                            <h5>Please select the sub-type of publisher that this site most closely classifies as:</h5>
                        </div>
                    </div>
                    <div class="row d-flex justify-content-center">
                        <div class="col-sm-11 pr-0 pl-0">
                            <div id="sub-publisher-options" class="btn-group btn-group-vertical" data-toggle="buttons" style="width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>
                <br />
                <!---->
                <div class="row p-3">
                    <button type="button" class="btn btn-primary col-sm-2 mr-auto" id="previous-page">
                        Previous
                    </button>
                    <button type="button" class="btn btn-success col-sm-2 ml-auto" id="presubmit" data-toggle="modal"
                        data-target="#submitModal">
                        Submit
                    </button>
                    <button type="button" class="btn btn-primary col-sm-2 ml-auto" id="next-page">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="submitModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title mx-auto">Submit your work?</h4>
                </div>
                <!-- Modal body -->
                <div class="modal-body">
                    Please make sure every question has been properly answered before
                    submitting your work. Incomplete work will not be rewarded!
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <input type="button" class="btn btn-danger ml-auto" data-dismiss="modal" value="Cancel" />
                    <input type="button" class="btn btn-success mr-auto" data-dismiss="modal" value="Submit"
                        id="submit" />
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="lanErrorModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title mx-auto">Warning</h4>
                </div>
                <!-- Modal body -->
                <div class="modal-body">
                    <span id="lan-warning-text">You didn't pass the language test. Please review your
                        answers and try again!</span>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <input type="button" class="btn btn-warning mx-auto" data-dismiss="modal" value="OK"
                        id="lan_close_error" />
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="errorModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title mx-auto">Warning</h4>
                </div>
                <!-- Modal body -->
                <div class="modal-body">
                    <span id="warning-text">Your answer didn't pass our quality check. Please review your
                        answers and try again!</span>
                    <span id="warning-hints"></span>
                </div>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <input type="button" class="btn btn-warning mx-auto" data-dismiss="modal" value="OK"
                        id="close_error" />
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="successModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title mx-auto">Success!</h4>
                </div>
                <!-- Modal body -->
                <div class="modal-body">
                    <span id="success-text">Your answer passed our quality check! Press finish to submit
                        them. We appreciate any feedback you may have on the task.</span>
                </div>
                <textarea class="form-control" rows="5" id="feedback_text"
                    placeholder="Type your feeback here ..."></textarea>
                <!-- Modal footer -->
                <div class="modal-footer">
                    <input type="button" class="btn btn-success mx-auto" data-dismiss="modal" value="Finish"
                        id="close_success" />
                </div>
            </div>
        </div>
    </div>
    <form name="mturk_form" method="post" id="mturk_form" action="https://www.mturk.com/mturk/externalSubmit">
        <input type="hidden" value="" name="assignmentId" id="assignmentId" />
        <input type="submit" id="submitButton" style="visibility: hidden;" />
        <input type="hidden" name="outputs" value="" id="outputs" />
        <input type="hidden" name="times" value="" id="times" />
        <input type="hidden" name="events" value="" id="events" />
        <input type="hidden" name="feedback" value="" id="feedback" />
    </form>
    <script language="Javascript">
        let sub_publisher_options = {
            0:[
                "Academic and research institutions (e.g. universities and research centres, but not museums and libraries, as those are cultural organisations)",
                "Academic publishers (e.g. journal and article publishers)",
                "Other academic organisations"
            ],
            1: [
                "Vendors and e-commerce companies",
                "Political or religious organisations",
                "Cultural institutions and organisations",
                "Other types of company"
            ],
            2: [],
            3: [
                "Traditional news and media (e.g. news agencies, broadcasters)",
                "Non-traditional news and media (e.g. online magazines, platforms to collaboratively create news)"
            ],
            4: [],
            5: []
        }
        let references = ${references}$
        let lan_test_language = ${lan_test_language}$;
        let lan_test_questions = ${lan_test_questions}$;

        let total = references.length;

        var outputs = [];
        // DEFAULT OUTPUTS IN JSON FORMAT, EX:  { similarity: -1, confidence: -1, reason: "" }
        // REPLACES THE GD FIELD WITH THE PROPER SET
        for (i = 0; i < total; i++) {
            outputs[i] = { author: -1, publisher: -1, sub_publisher: -1};
            if (references[i]['g_id'] != 0){
                references[i]['g_id'] = references[i]['g_id']['authorit'];
            }
        }

        var events = [];

        function log_event(event_type, event_attr) {
            event_obj = {
                timestamp: new Date(),
                type: event_type
            };
            if (event_attr != null) {
                event_obj.attr = event_attr;
            }
            events.push(event_obj);
        }

        log_event("page_displayed", null);

        var times = Array(total).fill(0.0);
        var links_clicked = Array(total).fill(false);
        var lastChange = null;

        failCount = 0;
        lanFailCount = 0;

        $("#instructions-project-text").html(${instructions_project_text}$);
        $("#instructions-intro-text").html(${instructions_intro_text}$);
        $("#instructions-rules-text").html(${instructions_rules_text}$);

        $("#lan_test_language").text(lan_test_language)

        for (i = 0; i < lan_test_questions.length; i++) {
            $('#lan_test').append(`<p class="mb-0">${lan_test_questions[i]['question']}</p>`)
            $('#lan_test').append(`<div id="lan_quest_${i}" class="btn-group btn-group-toggle mb-3" data-toggle="buttons">`)
            for (j = 0; j < lan_test_questions[i]['options'].length; j++)
                $(`#lan_quest_${i}`).append(`<label class="btn btn-primary"><input type="radio" autocomplete="off" value=${j} name='lang_quest_${i}'>${lan_test_questions[i]['options'][j]}<br/></label>`)
        }

        $("#n-pages").text(total);

        function showContent(currentPage) {
            if (lastChange) {
                times[parseInt($("#current-page").text()) - 1] +=
                    Date.now() - lastChange;
            }
            $("#current-page").text(currentPage);
            if (currentPage == 1) {
                $("#previous-page").hide();
                $("#next-page").show();
                $("#presubmit").hide();
            } else if (currentPage == total) {
                $("#previous-page").show();
                $("#next-page").hide();
                $("#presubmit").show();
            } else {
                $("#previous-page").show();
                $("#next-page").show();
                $("#presubmit").hide();
            }
            pageIndex = currentPage - 1;
            output = outputs[pageIndex];

            for (i = 0; i < 4; i++) {
                if (output['author'] == i) {
                    $(`#author_${i}`).addClass("active");
                    $(`#author_${i}`).children('input').prop('checked', true)
                } else {
                    $(`#author_${i}`).removeClass("active");
                    $(`#author_${i}`).children('input').prop('checked', false)
                }
            }

            for (i = 0; i < 6; i++) {
                if (output['publisher'] == i) {
                    $(`#publisher_${i}`).addClass("active");
                    $(`#publisher_${i}`).children('input').prop('checked', true)
                } else {
                    $(`#publisher_${i}`).removeClass("active");
                    $(`#publisher_${i}`).children('input').prop('checked', false)
                }
            }

            $('#sub-publisher-options').empty()
            if (output['publisher'] == -1){
                $('#sub-publisher-panel').addClass('d-none')
            } else if (sub_publisher_options[output['publisher']].length == 0) {
                $('#sub-publisher-panel').addClass('d-none')
            } else {
                $('#sub-publisher-panel').removeClass('d-none')
                for (i = 0; i < sub_publisher_options[output['publisher']].length; i++) {
                    $("#sub-publisher-options").append(
                        `<label id="sub_publisher_${i}" class="btn btn-primary subpublisher">
                            <input type="radio" autocomplete="off" value='unavailable' name='sub_publisher_radios'>
                            ${sub_publisher_options[output['publisher']][i]}
                        </label>`
                    );
                    $('label.btn.subpublisher').click(function () {
                        page = parseInt($("#current-page").text());
                        pageIndex = page - 1;
                        outputs[pageIndex]['sub_publisher'] = parseInt(this.id.split('sub_publisher_')[1]);
                    });
                    if (output['sub_publisher'] == i) {
                        $(`#sub_publisher_${i}`).addClass("active");
                        $(`#sub_publisher_${i}`).children('input').prop('checked', true)
                    } else {
                        $(`#sub_publisher_${i}`).removeClass("active");
                        $(`#sub_publisher_${i}`).children('input').prop('checked', false)
                    }
                } 
            }  

            $("#website_reference").text(references[pageIndex]["url"]);
            $("#website_reference").prop("href", references[pageIndex]["url"]);

            lastChange = Date.now();
        }

        function validateRegex(str) {
            var reU = /^(null|(?!0*[.]0*$|[.]0*$|0*$)\d+[.]?\d{0,}$)/;
            return reU.test(str);
        }

        function verifyLanguageAnswers() {
            allOK = 4;
            for (i = 0; i < lan_test_questions.length; i++) {
                let chosen = parseInt($(`input[name="lang_quest_${i}"]:checked`).val());
                if (chosen != lan_test_questions[i]['answer']) {
                    allOK = allOK - 1
                }
            }
            return (allOK == 4)
        }

        function verifyAnswers() {
            times[times.length - 1] += Date.now() - lastChange;
            lastChange = Date.now();

            var allControlsUsedCheck = true;
            const outputs_flat = [].concat(...outputs)
            for (i = 0; i < outputs_flat.length; i++){
                if (
                    (outputs_flat[i]["author"] == -1) ||
                    (outputs_flat[i]["publisher"] == -1)
                ) {
                    allControlsUsedCheck = false;
                }
                if (outputs_flat[i]["publisher"] != -1){
                    if (
                        (sub_publisher_options[outputs_flat[i]["publisher"]].length > 0) &&
                        (outputs_flat[i]["sub_publisher"] == -1)
                    ){
                        allControlsUsedCheck = false; 
                    }
                }
            }
            if (!allControlsUsedCheck) {
                log_event("verification_check_failed", {
                    check_failed: "outputs_moved_check",
                    outputs: JSON.parse(JSON.stringify(outputs))
                });
            }

            const links_clicked_flat = [].concat(...links_clicked)
            var allLinksClickedCheck = links_clicked_flat.every(Boolean)
            if (!allLinksClickedCheck) {
                log_event("verification_check_failed", {
                    check_failed: "links_clicked_check",
                    links_clicked: JSON.parse(JSON.stringify(links_clicked))
                });
            }

            var allTimesCheck = true;
            for (t of times) {
                if (t < ${time_thr}$) {
                    allTimesCheck = false;
                }
            }
            if (!allTimesCheck) {
                log_event("verification_check_failed", {
                    check_failed: "minimum_time_check",
                    times: JSON.parse(JSON.stringify(times))
                });
            }

            var allGoldenCheck = true;

            for (i = 0; i < total; i++) {
                if (references[i]['g_id'] != 0) {
                    if ((references[i]['g_id']['author'] != -1) && (outputs[i]['author'] != 3)){
                        if (references[i]['g_id']['author'].indexOf(outputs[i]['author']) == -1){
                            allGoldenCheck = false
                        }
                    }
                    if ((references[i]['g_id']['publisher'] != -1)  && (outputs[i]['publisher'] != 5)){
                        if (references[i]['g_id']['publisher'].indexOf(outputs[i]['publisher']) == -1){
                            allGoldenCheck = false
                        }
                    }
                    if (references[i]['g_id']['sub_publisher'] != -1){
                        if (references[i]['g_id']['sub_publisher'].indexOf(outputs[i]['sub_publisher']) == -1){
                            allGoldenCheck = false
                        }
                    }
                }
            }
            if (!allGoldenCheck) {
                log_event("verification_check_failed", {
                    check_failed: "golden_standard_check",
                    outputs: JSON.parse(JSON.stringify(outputs))
                });
            }

            //allGoldenCheck = true;

            return {'controls':allControlsUsedCheck, 'times':allTimesCheck, 'golden':allGoldenCheck, 'links':allLinksClickedCheck};
        }

        $(function () {
            $("#previous-page").click(function () {
                var page = parseInt($("#current-page").text());
                newPage = page - 1;
                showContent(newPage);
                log_event("moved_backward", {
                    new_page_index: newPage,
                    outputs: JSON.parse(JSON.stringify(outputs))
                });
            });
            $("#next-page").click(function () {
                var page = parseInt($("#current-page").text());
                newPage = page + 1;
                showContent(newPage);
                log_event("moved_forward", {
                    new_page_index: newPage,
                    outputs: JSON.parse(JSON.stringify(outputs))
                });
            });
            $("#ready-button").click(function () {
                if (verifyLanguageAnswers()) {
                    $("#instructions-0").addClass("d-none");
                    $("#instructions-1").removeClass("d-none");
                    $("#instructions-2").removeClass("d-none");
                    $("#instructions-3").removeClass("d-none");
                    $("#instructions-4").addClass("d-none");
                    $("#instructions-btns").addClass("d-none");
                    $(this).addClass("d-none");
                    $("#instructions-toggle").removeClass("d-none");
                    $("#instructions-panel").addClass("collapse");
                    $("#task-panel").removeClass("d-none");
                    showContent(1);
                    log_event("task_started", null);
                } else {
                    lanFailCount = lanFailCount + 1;
                    if (lanFailCount >= 3) {
                        $("#lan-warning-text").html(
                            "You didn't pass the language test.<br><br><strong>Unfortunately, you've reached the maximum amount of trials.<br><br>This window will be erased. Thank you very much for your work and please press return above so other worker may take this task.</strong>"
                        );
                        $("#lanErrorModal").modal("toggle");
                        $("#lanErrorModal").on("hidden.bs.modal", function () {
                            $("*").empty();
                        });
                    } else {
                        $("#lanErrorModal").modal("toggle");
                    }
                }
            });
            $("#instructions-toggle").click(function () {
                is_shown = $("#instructions-panel").hasClass("show");
                if (is_shown) {
                    $("#instructions-toggle-text").text("Show Instructions");
                    log_event("closed_instructions", null);
                } else {
                    $("#instructions-toggle-text").text("Hide Instructions");
                    log_event("opened_instructions", null);
                }
            });
            $('label.btn').click(function () {
                page = parseInt($("#current-page").text());
                pageIndex = page - 1;
                if (this.id.startsWith('author')) {
                    outputs[pageIndex]['author'] = parseInt(this.id.split('author_')[1]);
                } else if (this.id.startsWith('publisher')) {
                    outputs[pageIndex]['publisher'] = parseInt(this.id.split('publisher_')[1]);
                    $('#sub-publisher-options').empty();
                    if (sub_publisher_options[outputs[pageIndex]['publisher']].length == 0){
                        $('#sub-publisher-panel').addClass('d-none');
                    } else {
                        $('#sub-publisher-panel').removeClass('d-none');
                        for (i = 0; i < sub_publisher_options[outputs[pageIndex]['publisher']].length; i++) {
                            $("#sub-publisher-options").append(
                                `<label id="sub_publisher_${i}" class="btn btn-primary subpublisher">
                                    <input type="radio" autocomplete="off" value='unavailable' name='sub_publisher_radios'>
                                    ${sub_publisher_options[outputs[pageIndex]['publisher']][i]}
                                </label>`
                            )
                        };
                        $('label.btn.subpublisher').click(function () {
                            page = parseInt($("#current-page").text());
                            pageIndex = page - 1;
                            outputs[pageIndex]['sub_publisher'] = parseInt(this.id.split('sub_publisher_')[1]);
                        })
                    }
                }
            });
            $('#website_reference').on('click auxclick', function (e) {
                if (e.which <= 2) {
                    page = parseInt($("#current-page").text());
                    pageIndex = page - 1;
                    links_clicked[pageIndex] = true;
                }
            });
            $('#intro-next').click(function () {
                let current_instructions_active = $('div.instructions.active')[0];
                let current_instructions_id = parseInt(current_instructions_active.id.split('instructions-')[1]);
                $(`#instructions-${current_instructions_id}`).addClass('d-none').removeClass('active');
                $(`#instructions-${current_instructions_id + 1}`).removeClass('d-none').addClass('active');
                if (current_instructions_id == 0) {
                    $('#intro-previous').removeClass('d-none');
                } else if (current_instructions_id == 3) {
                    $('#intro-next').addClass('d-none');
                    $('#ready-button').removeClass('d-none');
                }
            });
            $('#intro-previous').click(function () {
                let current_instructions_active = $('div.instructions.active')[0];
                let current_instructions_id = parseInt(current_instructions_active.id.split('instructions-')[1]);
                $(`#instructions-${current_instructions_id}`).addClass('d-none').removeClass('active');
                $(`#instructions-${current_instructions_id - 1}`).removeClass('d-none').addClass('active');
                if (current_instructions_id == 4) {
                    $('#ready-button').addClass('d-none');
                    $('#intro-next').removeClass('d-none');
                } else if (current_instructions_id == 1) {
                    $('#intro-previous').addClass('d-none');
                }
            });
            $("#submit").click(function () {
                let verification = verifyAnswers();
                if (verification['controls'] && verification['times'] && verification['links'] && verification['golden']){
                    $("#successModal").modal("toggle");
                    $("#successModal").on("hidden.bs.modal", function () {
                        log_event("task_finished", null);
                        $("#feedback").val($("#feedback_text").val());
                        $("#outputs").val(JSON.stringify(outputs));
                        $("#times").val(JSON.stringify(times));
                        $("#events").val(JSON.stringify(events));
                        $("#submitButton").trigger("click");
                    });
                } else {
                    failCount = failCount + 1;
                    $("#warning-hints").empty();
                    let warningString = "<ul>"
                    if (!verification['controls']){
                        warningString += "<li>You did not provide all required answers. Please provide answers to every question required. Maybe you skipped the last one. If you provided answers to a non-required question, that is ok. If any slider is in the position you want, but grey, click on it to turn it blue.</li>"
                    }
                    if (!verification['times']){
                        warningString += "<li>You seem to have filled some questions too quickly and we suspected bot activity. Spend a couple of seconds more in each item, maybe review your answers.</li>"
                    }
                    if (!verification['links']){
                        warningString += "<li>You did not click at all links. Remember to click with the left button, or we can not detect it.</li>"
                    }
                    if (!verification['golden']){
                        warningString += "<li>We know the answers for a small portion of the questions, and you seem to disagree with us. Please review your answers, but if you feel you are right even so, please contact the Requester.</li>"
                    }
                    warningString += "</ul>"
                    $("#warning-hints").html(warningString);
                    if (failCount >= 3) {
                        $("#warning-text").html(
                            "Your answer didn't pass our quality check.<br><br><strong>Unfortunately, you've reached the maximum amount of trials.<br><br>This window will be erased. Thank you very much for your work and please press return above so other worker may take this task.</strong>"
                        );
                        $("#errorModal").modal("toggle");
                        $("#errorModal").on("hidden.bs.modal", function () {
                            $("*").empty();
                        });
                    } else {
                        $("#errorModal").modal("toggle");
                    }
                }
            });
        });
        turkSetAssignmentID();
    </script>
</body>

</html>